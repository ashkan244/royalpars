<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Royal Week Campaign</title>
    
    <!-- 1. بارگذاری Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. بارگذاری فونت وزیرمتن -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    
    <!-- 3. بارگذاری Babel برای اجرای React -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- تنظیمات استایل پایه -->
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #09090b;
            margin: 0;
            overflow: hidden; /* جلوگیری از اسکرول اضافه */
        }
        
        .neon-button {
            box-shadow: 0 0 10px #f59e0b, 0 0 20px #f59e0b, 0 0 40px #f59e0b;
            animation: neon-pulse 1.5s infinite alternate;
        }
        @keyframes neon-pulse {
            from { box-shadow: 0 0 10px #f59e0b, 0 0 20px #f59e0b; opacity: 0.9; }
            to { box-shadow: 0 0 15px #f59e0b, 0 0 30px #f59e0b, 0 0 50px #f59e0b; opacity: 1; }
        }
    </style>
</head>
<body>

    <div id="root"></div>

    <!-- 4. اسکریپت اصلی برنامه -->
    <script type="text/babel" data-type="module">
        // ایمپورت کردن کتابخانه‌ها از CDN
        import React, { useState, useEffect } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { Sparkles, Camera, Fingerprint } from 'https://esm.sh/lucide-react@0.292.0';

        // --- هلپر برای جلوگیری از خطا در فایل لوکال ---
        const safeStorage = {
            getItem: (key) => {
                try { return localStorage.getItem(key); } catch(e) { return null; }
            },
            setItem: (key, value) => {
                try { localStorage.setItem(key, value); } catch(e) {}
            }
        };

        // --- تنظیمات لیست جوایز ---
        const PRIZE_CONFIG = [
            { 
                id: 'cbook', 
                brand: 'فروشگاه سی‌بوک', 
                discount: 'یک جلد کتاب', 
                label: 'هدیه فرهنگی', 
                limit: 10, 
                prefix: 'BK', 
                color: 'from-emerald-400 to-teal-600' 
            },
            { 
                id: 'sarak', 
                brand: 'فروشگاه سارک', 
                discount: '۲۵۰,۰۰۰', 
                label: 'تومان تخفیف', 
                limit: 10, 
                prefix: 'SR', 
                color: 'from-rose-400 to-red-600' 
            },
            { 
                id: 'zarsam', 
                brand: 'زرسام', 
                discount: '۲۵۰,۰۰۰', 
                label: 'تومان تخفیف', 
                limit: 10, 
                prefix: 'ZR', 
                color: 'from-amber-300 to-yellow-600' 
            },
            { 
                id: 'tulika', 
                brand: 'تولیکا', 
                discount: '۳۰۰,۰۰۰', 
                label: 'تومان تخفیف', 
                limit: 10, 
                prefix: 'TL', 
                color: 'from-purple-400 to-indigo-600' 
            },
            { 
                id: 'nabhani', 
                brand: 'نبهانی', 
                discount: '۶۰٪', 
                label: 'تخفیف ویژه', 
                limit: 20, 
                prefix: 'NB', 
                color: 'from-blue-400 to-cyan-600' 
            },
            { 
                id: 'collection', 
                brand: 'فروشگاه کالکشن', 
                discount: '۳۰٪', 
                label: 'تخفیف روی کل اجناس', 
                limit: null, 
                prefix: 'CL', 
                color: 'from-slate-300 to-slate-500' 
            }
        ];

        function RoyalCampaignApp() {
            const [step, setStep] = useState('intro'); // intro | loading | result
            const [prize, setPrize] = useState(null);

            useEffect(() => {
                // چک کردن جایزه قبلی
                const existingPrize = safeStorage.getItem('royal_week_prize_v_final');
                if (existingPrize) {
                    setPrize(JSON.parse(existingPrize));
                    setStep('result');
                }
                
                // مقداردهی اولیه شمارشگر
                if (!safeStorage.getItem('prize_counts')) {
                    safeStorage.setItem('prize_counts', JSON.stringify({}));
                }
            }, []);

            const handleStartLottery = () => {
                setStep('loading');

                // 1. خواندن موجودی
                const counts = JSON.parse(safeStorage.getItem('prize_counts') || '{}');

                // 2. فیلتر کردن مجازها
                const availablePrizes = PRIZE_CONFIG.filter(p => {
                    if (p.limit === null) return true;
                    const used = counts[p.id] || 0;
                    return used < p.limit;
                });

                // 3. انتخاب رندوم
                const selectedPool = availablePrizes.length > 0 ? availablePrizes : [PRIZE_CONFIG[PRIZE_CONFIG.length - 1]];
                const randomIndex = Math.floor(Math.random() * selectedPool.length);
                const selectedPrize = selectedPool[randomIndex];
                
                // 4. آپدیت موجودی
                counts[selectedPrize.id] = (counts[selectedPrize.id] || 0) + 1;
                safeStorage.setItem('prize_counts', JSON.stringify(counts));

                // 5. تولید کد
                const randomCode = `${selectedPrize.prefix}-${Math.floor(1000 + Math.random() * 9000)}`;

                const newPrizeData = {
                    ...selectedPrize,
                    code: randomCode,
                    date: new Date().toLocaleDateString('fa-IR')
                };

                setTimeout(() => {
                    safeStorage.setItem('royal_week_prize_v_final', JSON.stringify(newPrizeData));
                    setPrize(newPrizeData);
                    setStep('result');
                }, 2500); 
            };

            // --- کامپوننت‌ها ---
            const RenderIntro = () => (
                <div className="flex flex-col items-center justify-center text-center w-full max-w-[360px] animate-[fadeIn_0.7s_ease-out]">
                    <h1 className="text-4xl font-black text-white mb-12 drop-shadow-[0_0_15px_rgba(255,255,255,0.3)] leading-tight">
                        چه تخفیفی<br/>بهت بدم..؟
                    </h1>
                    <button 
                        onClick={handleStartLottery}
                        className="neon-button relative group bg-transparent border-[3px] border-amber-500 text-amber-500 text-3xl font-black py-6 px-12 rounded-full transition-transform duration-300 active:scale-95 hover:scale-105 cursor-pointer"
                    >
                        <span className="relative z-10 flex items-center gap-3">
                            <Fingerprint className="animate-pulse" size={32} />
                            بزن اینجا
                        </span>
                        <div className="absolute inset-0 rounded-full bg-amber-500 opacity-20 blur-xl group-hover:opacity-40 transition-opacity"></div>
                    </button>
                    <p className="text-zinc-500 text-xs mt-12 animate-pulse">ROYAL WEEK • TAP TO START</p>
                </div>
            );

            const RenderLoading = () => (
                <div className="flex flex-col items-center">
                    <div className="relative">
                        <div className="w-24 h-24 border-[6px] border-zinc-700 border-t-amber-500 rounded-full animate-spin"></div>
                        <div className="absolute inset-0 flex items-center justify-center">
                            <Sparkles className="text-amber-500 animate-pulse" size={24} />
                        </div>
                    </div>
                    <h2 className="text-xl font-black text-zinc-300 mt-6 animate-pulse">در حال قرعه‌کشی...</h2>
                </div>
            );

            const RenderResult = () => {
                if (!prize) return null;
                const isLongText = prize.discount.length > 5;
                const textSizeClass = isLongText ? "text-[4rem]" : "text-[7rem]";

                return (
                    <div className="w-full max-w-[400px] animate-[slideUp_0.7s_ease-out]">
                        <div className="text-center mb-6">
                            <div className="inline-flex items-center gap-2 bg-white/5 backdrop-blur-sm border border-white/10 rounded-2xl px-5 py-2 mb-3 shadow-lg">
                                <Sparkles size={20} className="text-amber-400 fill-amber-400/50" />
                                <span className="text-lg text-zinc-100 font-black tracking-wide drop-shadow-sm">برنده خوش‌شانس امروز</span>
                            </div>
                            <h1 className="text-5xl font-black text-white drop-shadow-[0_4px_4px_rgba(0,0,0,0.5)] tracking-tighter">تبریک!</h1>
                        </div>

                        <div className="bg-gradient-to-b from-zinc-800 to-zinc-900 rounded-[2.5rem] border border-white/10 shadow-[0_20px_60px_-15px_rgba(0,0,0,0.7)] relative overflow-hidden ring-1 ring-white/5">
                            <div className="absolute top-0 left-0 right-0 h-[1px] bg-gradient-to-r from-transparent via-white/30 to-transparent"></div>
                            <div className="absolute -left-4 top-1/2 transform -translate-y-1/2 w-8 h-8 bg-zinc-950 border-r border-white/10 rounded-full z-20"></div>
                            <div className="absolute -right-4 top-1/2 transform -translate-y-1/2 w-8 h-8 bg-zinc-950 border-l border-white/10 rounded-full z-20"></div>

                            <div className="p-6 pb-0 flex flex-col items-center text-center relative z-10">
                                <div className="mb-5 w-full">
                                    <span className="block text-zinc-400 text-base font-black mb-2 uppercase tracking-wide">قابل استفاده در:</span>
                                    <h2 className="text-[2.2rem] leading-none font-black text-white drop-shadow-md break-words">
                                        {prize.brand}
                                    </h2>
                                </div>

                                <div className="w-full border-t-[3px] border-dashed border-zinc-700/50 my-2"></div>

                                <div className="py-3 relative w-full">
                                    <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-32 h-32 bg-amber-500/20 blur-3xl rounded-full"></div>
                                    <span className={`relative ${textSizeClass} leading-none font-black bg-gradient-to-b ${prize.color} bg-clip-text text-transparent drop-shadow-xl tracking-tighter filter brightness-110 block py-2`}>
                                        {prize.discount}
                                    </span>
                                    <span className="block text-zinc-300 text-2xl font-black mt-[-0.5rem] drop-shadow-md">{prize.label}</span>
                                </div>

                                <div className="mt-5 mb-6 bg-black/30 backdrop-blur-sm w-full py-5 rounded-2xl border border-white/5 inner-shadow">
                                    <p className="text-zinc-500 text-sm font-black mb-1">کد اختصاصی شما</p>
                                    <p className="text-4xl font-mono font-black text-amber-500 tracking-[0.15em] drop-shadow-sm">{prize.code}</p>
                                </div>
                            </div>

                            <div className="bg-amber-500 p-5 flex items-center justify-center gap-4 border-t border-amber-400/50 relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-full h-full bg-gradient-to-b from-white/20 to-transparent pointer-events-none"></div>
                                <div className="bg-black/20 p-3 rounded-2xl animate-pulse backdrop-blur-sm">
                                    <Camera className="text-black/80" size={32} strokeWidth={2.5} />
                                </div>
                                <div className="text-right z-10">
                                    <p className="text-black font-black text-3xl leading-none mb-1 drop-shadow-sm">اسکرین‌شات بگیرید</p>
                                    <p className="text-black/70 text-base font-bold leading-none mt-1">و به فروشنده نشان دهید</p>
                                </div>
                            </div>
                        </div>
                        <p className="text-center text-xs text-zinc-500 mt-8 font-bold opacity-70 tracking-widest">ROYAL WEEK CAMPAIGN</p>
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-zinc-950 text-white flex flex-col items-center justify-center p-4 relative overflow-hidden" dir="rtl">
                    <div className="absolute inset-0 bg-[radial-gradient(circle_at_top,_var(--tw-gradient-stops))] from-zinc-800 via-zinc-950 to-black pointer-events-none"></div>
                    <div className="relative z-10 w-full flex justify-center">
                        {step === 'intro' && <RenderIntro />}
                        {step === 'loading' && <RenderLoading />}
                        {step === 'result' && <RenderResult />}
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<RoyalCampaignApp />);
    </script>
    
    <!-- استایل‌های انیمیشن که در CSS اینلاین سخت بود -->
    <style>
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</body>
</html>